<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rhythm Game</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            overflow: hidden;
            background-color: #1a1a2e;
        }
        .key {
            transition: all 0.07s ease;
            border-bottom-width: 8px;
        }
        .key.pressed {
            transform: scale(0.95);
            border-bottom-width: 4px;
            filter: brightness(1.2);
        }
        #game-container {
            touch-action: manipulation;
        }
        .feedback {
            animation: fadeOutUp 0.5s forwards;
        }
        @keyframes fadeOutUp {
            from {
                opacity: 1;
                transform: translateY(0);
            }
            to {
                opacity: 0;
                transform: translateY(-50px);
            }
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex items-center justify-center min-h-screen">

    <div id="game-container" class="w-full max-w-md mx-auto text-center">
        <div id="start-screen" class="p-8">
            <h1 class="text-5xl font-bold mb-4 text-cyan-400">Rhythm Master</h1>
            <p class="text-lg mb-8 text-gray-300">Tap to the beat of the music!</p>
            <div class="mb-6">
                <label for="song-select" class="block mb-2 text-sm font-medium text-gray-400">Select a Song:</label>
                <select id="song-select" class="bg-gray-800 border border-gray-700 text-white text-sm rounded-lg focus:ring-cyan-500 focus:border-cyan-500 block w-full p-2.5">
                    <!-- Song options will be populated by JS -->
                </select>
            </div>
            <button id="start-button" class="w-full bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-3 px-6 rounded-lg text-xl transition duration-300 transform hover:scale-105">
                Start Game
            </button>
             <div class="mt-8 text-sm text-gray-500">
                <p>Use keys: D, F, J, K</p>
            </div>
        </div>

        <div id="game-screen" class="hidden relative">
            <div id="ui-overlay" class="absolute top-0 left-0 w-full p-4 z-20 flex justify-between items-start">
                <div>
                    <p class="text-lg font-semibold">Score: <span id="score">0</span></p>
                </div>
                <div class="text-right">
                    <p class="text-3xl font-bold text-cyan-400">Combo: <span id="combo">0</span></p>
                </div>
            </div>

            <canvas id="gameCanvas" class="bg-gray-800 rounded-lg shadow-2xl"></canvas>
            
            <div id="feedback-container" class="absolute inset-0 flex items-center justify-center pointer-events-none z-30">
                 {/* Feedback text like 'Perfect', 'Miss' will appear here */}
            </div>

            <div id="key-press-indicators" class="w-full mt-2 grid grid-cols-4 gap-2">
                <div id="key-d" class="key bg-pink-500 border-pink-700 rounded-lg p-4 h-24 flex items-center justify-center text-2xl font-bold">D</div>
                <div id="key-f" class="key bg-purple-500 border-purple-700 rounded-lg p-4 h-24 flex items-center justify-center text-2xl font-bold">F</div>
                <div id="key-j" class="key bg-blue-500 border-blue-700 rounded-lg p-4 h-24 flex items-center justify-center text-2xl font-bold">J</div>
                <div id="key-k" class="key bg-green-500 border-green-700 rounded-lg p-4 h-24 flex items-center justify-center text-2xl font-bold">K</div>
            </div>
        </div>
        
        <div id="end-screen" class="hidden p-8">
            <h2 class="text-4xl font-bold mb-2">Game Over</h2>
            <p class="text-2xl mb-4">Final Score: <span id="final-score" class="text-cyan-400 font-bold">0</span></p>
            <p class="text-xl mb-6">Max Combo: <span id="max-combo" class="text-cyan-400 font-bold">0</span></p>
            <button id="restart-button" class="w-full bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-3 px-6 rounded-lg text-xl transition duration-300 transform hover:scale-105">
                Play Again
            </button>
        </div>

    </div>

    <audio id="game-audio" preload="auto"></audio>

    <script>
        // --- DOM Elements ---
        const startScreen = document.getElementById('start-screen');
        const gameScreen = document.getElementById('game-screen');
        const endScreen = document.getElementById('end-screen');
        const startButton = document.getElementById('start-button');
        const restartButton = document.getElementById('restart-button');
        const songSelect = document.getElementById('song-select');

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        const scoreDisplay = document.getElementById('score');
        const comboDisplay = document.getElementById('combo');
        const finalScoreDisplay = document.getElementById('final-score');
        const maxComboDisplay = document.getElementById('max-combo');
        const feedbackContainer = document.getElementById('feedback-container');
        
        const gameAudio = document.getElementById('game-audio');

        // --- Game Configuration ---
        const lanes = 4;
        const tileHeight = 50;
        const tileSpeed = 500; // Pixels per second
        
        const keyMap = { 'd': 0, 'f': 1, 'j': 2, 'k': 3 };
        const keyElements = {
            'd': document.getElementById('key-d'),
            'f': document.getElementById('key-f'),
            'j': document.getElementById('key-j'),
            'k': document.getElementById('key-k'),
        };
        const laneColors = ['#ff3d8b', '#a33dff', '#3d91ff', '#3dff8b'];

        // --- Hit Windows (in seconds) ---
        const hitWindows = {
            perfect: 0.05,
            great: 0.1,
            good: 0.15,
            miss: 0.2
        };

        const scores = {
            perfect: 100,
            great: 75,
            good: 50,
            miss: 0
        };

        // --- Game State ---
        let score = 0;
        let combo = 0;
        let maxCombo = 0;
        let tiles = [];
        let upcomingTiles = [];
        let currentSong;
        let audioStartTime = 0;
        let isPlaying = false;
        let animationFrameId;

        // --- Song Data ---
        const songs = [
            {
                title: "Creative Minds",
                artist: "RoyaltyFreeMusic",
                url: "https://www.bensound.com/bensound-music/bensound-creativeminds.mp3",
                bpm: 85,
                beatmap: [
                    { time: 2.8, lane: 0 }, { time: 3.5, lane: 1 }, { time: 4.2, lane: 2 }, { time: 4.9, lane: 3 },
                    { time: 5.6, lane: 0 }, { time: 5.95, lane: 1 }, { time: 6.3, lane: 0 }, { time: 6.65, lane: 1 },
                    { time: 7.0, lane: 2 }, { time: 7.35, lane: 3 }, { time: 7.7, lane: 2 }, { time: 8.05, lane: 3 },
                    { time: 8.4, lane: 0 }, { time: 9.1, lane: 2 }, { time: 9.8, lane: 1 }, { time: 10.5, lane: 3 },
                    { time: 11.2, lane: 0 }, { time: 11.2, lane: 3 }, { time: 11.9, lane: 1 }, { time: 11.9, lane: 2 },
                    { time: 12.6, lane: 0 }, { time: 12.95, lane: 1 }, { time: 13.3, lane: 2 }, { time: 13.65, lane: 3 },
                    { time: 14.0, lane: 0 }, { time: 14.175, lane: 1 }, { time: 14.35, lane: 2 }, { time: 14.525, lane: 3 },
                    { time: 14.7, lane: 0 }, { time: 14.875, lane: 1 }, { time: 15.05, lane: 2 }, { time: 15.225, lane: 3 },
                    { time: 15.4, lane: 0 }, { time: 16.1, lane: 1 }, { time: 16.8, lane: 2 }, { time: 17.5, lane: 3 },
                    { time: 18.2, lane: 0 }, { time: 18.2, lane: 1 },
                    { time: 19.6, lane: 2 }, { time: 19.6, lane: 3 },
                    { time: 21.0, lane: 0 }, { time: 21.35, lane: 1 }, { time: 21.7, lane: 2 }, { time: 22.05, lane: 3 },
                    { time: 22.4, lane: 0 }, { time: 22.4, lane: 3 }, { time: 23.1, lane: 1 }, { time: 23.1, lane: 2 },
                    { time: 23.8, lane: 0 }, { time: 24.5, lane: 2 }, { time: 25.2, lane: 1 }, { time: 25.9, lane: 3 },
                    { time: 26.6, lane: 0 }, { time: 26.6, lane: 1 }, { time: 27.3, lane: 2 }, { time: 27.3, lane: 3 },
                    { time: 28.0, lane: 0 }, { time: 28.35, lane: 2 }, { time: 28.7, lane: 0 }, { time: 29.05, lane: 2 },
                    { time: 29.4, lane: 1 }, { time: 29.75, lane: 3 }, { time: 30.1, lane: 1 }, { time: 30.45, lane: 3 },
                    { time: 30.8, lane: 0 },
                    { time: 31.5, lane: 3 },
                    { time: 32.2, lane: 1 },
                    { time: 32.9, lane: 2 },
                    { time: 33.6, lane: 0 }, { time: 33.95, lane: 1 }, { time: 34.3, lane: 2 }, { time: 34.65, lane: 3 },
                    { time: 35.0, lane: 3 }, { time: 35.35, lane: 2 }, { time: 35.7, lane: 1 }, { time: 36.05, lane: 0 },
                    { time: 36.4, lane: 0 }, { time: 36.575, lane: 1 }, { time: 36.75, lane: 0 }, { time: 36.925, lane: 1 },
                    { time: 37.1, lane: 2 }, { time: 37.275, lane: 3 }, { time: 37.45, lane: 2 }, { time: 37.625, lane: 3 },
                    { time: 37.8, lane: 0 }, { time: 37.8, lane: 2 },
                    { time: 38.5, lane: 1 }, { time: 38.5, lane: 3 },
                    { time: 39.2, lane: 0 }, { time: 39.2, lane: 3 },
                    { time: 39.9, lane: 1 }, { time: 39.9, lane: 2 },
                    { time: 42.0, lane: 0 }, { time: 42.7, lane: 1 }, { time: 43.4, lane: 2 }, { time: 44.1, lane: 3 },
                    { time: 44.8, lane: 0 }, { time: 45.15, lane: 2 }, { time: 45.5, lane: 0 }, { time: 45.85, lane: 2 },
                    { time: 46.2, lane: 1 }, { time: 46.55, lane: 3 }, { time: 46.9, lane: 1 }, { time: 47.25, lane: 3 },
                    { time: 47.6, lane: 0 }, { time: 47.95, lane: 1 }, { time: 48.3, lane: 2 }, { time: 48.65, lane: 3 },
                    { time: 49.0, lane: 0 }, { time: 49.0, lane: 1 }, { time: 49.7, lane: 2 }, { time: 49.7, lane: 3 },
                    { time: 50.4, lane: 0 }, { time: 50.75, lane: 1 }, { time: 51.1, lane: 0 }, { time: 51.45, lane: 1 },
                    { time: 51.8, lane: 2 }, { time: 52.15, lane: 3 }, { time: 52.5, lane: 2 }, { time: 52.85, lane: 3 },
                    { time: 53.2, lane: 0 }, { time: 53.2, lane: 2 },
                    { time: 53.9, lane: 1 }, { time: 53.9, lane: 3 },
                    { time: 54.6, lane: 0 }, { time: 55.3, lane: 1 }, { time: 56.0, lane: 2 }, { time: 56.7, lane: 3 },
                    { time: 57.4, lane: 0 }, { time: 57.75, lane: 1 }, { time: 58.1, lane: 2 }, { time: 58.45, lane: 3 },
                    { time: 58.8, lane: 0 }, { time: 58.8, lane: 3 },
                    { time: 59.5, lane: 1 }, { time: 59.5, lane: 2 },
                    { time: 60.2, lane: 0 }, { time: 60.9, lane: 2 }, { time: 61.6, lane: 1 }, { time: 62.3, lane: 3 },
                    { time: 63.0, lane: 0 }, { time: 63.35, lane: 1 }, { time: 63.7, lane: 0 }, { time: 64.05, lane: 1 },
                    { time: 64.4, lane: 2 }, { time: 64.75, lane: 3 }, { time: 65.1, lane: 2 }, { time: 65.45, lane: 3 },
                    { time: 65.8, lane: 0 }, { time: 66.5, lane: 1 }, { time: 67.2, lane: 2 }, { time: 67.9, lane: 3 },
                    { time: 68.6, lane: 0 }, { time: 68.6, lane: 2 }, { time: 69.3, lane: 1 }, { time: 69.3, lane: 3 },
                    { time: 70.0, lane: 0 }, { time: 70.35, lane: 1 }, { time: 70.7, lane: 2 }, { time: 71.05, lane: 3 },
                    { time: 71.4, lane: 0 }, { time: 71.4, lane: 3 },
                    { time: 72.1, lane: 1 }, { time: 72.1, lane: 2 },
                    { time: 72.8, lane: 0 }, { time: 73.5, lane: 2 }, { time: 74.2, lane: 1 }, { time: 74.9, lane: 3 },
                    { time: 75.6, lane: 0 }, { time: 75.95, lane: 1 }, { time: 76.3, lane: 0 }, { time: 76.65, lane: 1 },
                    { time: 77.0, lane: 2 }, { time: 77.35, lane: 3 }, { time: 77.7, lane: 2 }, { time: 78.05, lane: 3 },
                    { time: 78.4, lane: 0 }, { time: 79.1, lane: 1 }, { time: 79.8, lane: 2 }, { time: 80.5, lane: 3 },
                    { time: 81.2, lane: 0 }, { time: 81.2, lane: 1 }, { time: 81.9, lane: 2 }, { time: 81.9, lane: 3 },
                    { time: 82.6, lane: 0 }, { time: 82.95, lane: 1 }, { time: 83.3, lane: 2 }, { time: 83.65, lane: 3 },
                    { time: 84.0, lane: 0 }, { time: 84.0, lane: 3 },
                    { time: 84.7, lane: 1 }, { time: 84.7, lane: 2 },
                    { time: 85.4, lane: 0 }, { time: 86.1, lane: 2 }, { time: 86.8, lane: 1 }, { time: 87.5, lane: 3 },
                    { time: 88.2, lane: 0 }, { time: 88.55, lane: 1 }, { time: 88.9, lane: 0 }, { time: 89.25, lane: 1 },
                    { time: 89.6, lane: 2 }, { time: 89.95, lane: 3 }, { time: 90.3, lane: 2 }, { time: 90.65, lane: 3 },
                    { time: 91.0, lane: 0 }, { time: 91.7, lane: 1 }, { time: 92.4, lane: 2 }, { time: 93.1, lane: 3 },
                    { time: 93.8, lane: 0 }, { time: 93.8, lane: 2 }, { time: 94.5, lane: 1 }, { time: 94.5, lane: 3 },
                    { time: 95.2, lane: 0 }, { time: 95.55, lane: 1 }, { time: 95.9, lane: 2 }, { time: 96.25, lane: 3 },
                    { time: 96.6, lane: 0 }, { time: 96.6, lane: 3 },
                    { time: 97.3, lane: 1 }, { time: 97.3, lane: 2 },
                    { time: 98.0, lane: 0 }, { time: 98.7, lane: 2 }, { time: 99.4, lane: 1 }, { time: 100.1, lane: 3 },
                    { time: 100.8, lane: 0 }, { time: 101.15, lane: 1 }, { time: 101.5, lane: 0 }, { time: 101.85, lane: 1 },
                    { time: 102.2, lane: 2 }, { time: 102.55, lane: 3 }, { time: 102.9, lane: 2 }, { time: 103.25, lane: 3 },
                    { time: 103.6, lane: 0 }, { time: 104.3, lane: 1 }, { time: 105.0, lane: 2 }, { time: 105.7, lane: 3 },
                    { time: 106.4, lane: 0 }, { time: 106.4, lane: 1 }, { time: 107.1, lane: 2 }, { time: 107.1, lane: 3 },
                    { time: 107.8, lane: 0 }, { time: 108.15, lane: 1 }, { time: 108.5, lane: 2 }, { time: 108.85, lane: 3 },
                    { time: 109.2, lane: 0 }, { time: 109.2, lane: 3 },
                    { time: 109.9, lane: 1 }, { time: 109.9, lane: 2 },
                    { time: 110.6, lane: 0 }, { time: 111.3, lane: 2 }, { time: 112.0, lane: 1 }, { time: 112.7, lane: 3 },
                    { time: 113.4, lane: 0 }, { time: 113.75, lane: 1 }, { time: 114.1, lane: 0 }, { time: 114.45, lane: 1 },
                    { time: 114.8, lane: 2 }, { time: 115.15, lane: 3 }, { time: 115.5, lane: 2 }, { time: 115.85, lane: 3 },
                    { time: 116.2, lane: 0 }, { time: 116.9, lane: 1 }, { time: 117.6, lane: 2 }, { time: 118.3, lane: 3 },
                    { time: 119.0, lane: 0 }, { time: 119.0, lane: 2 }, { time: 119.7, lane: 1 }, { time: 119.7, lane: 3 },
                    { time: 120.4, lane: 0 }, { time: 120.75, lane: 1 }, { time: 121.1, lane: 2 }, { time: 121.45, lane: 3 },
                    { time: 121.8, lane: 0 }, { time: 121.8, lane: 3 },
                    { time: 122.5, lane: 1 }, { time: 122.5, lane: 2 },
                    { time: 123.2, lane: 0 }, { time: 123.9, lane: 2 }, { time: 124.6, lane: 1 }, { time: 125.3, lane: 3 },
                    { time: 126.0, lane: 0 }, { time: 126.35, lane: 1 }, { time: 126.7, lane: 0 }, { time: 127.05, lane: 1 },
                    { time: 127.4, lane: 2 }, { time: 127.75, lane: 3 }, { time: 128.1, lane: 2 }, { time: 128.45, lane: 3 },
                    { time: 128.8, lane: 0 }, { time: 129.5, lane: 1 }, { time: 130.2, lane: 2 }, { time: 130.9, lane: 3 },
                    { time: 131.6, lane: 0 }, { time: 131.6, lane: 1 }, { time: 132.3, lane: 2 }, { time: 132.3, lane: 3 },
                    { time: 133.0, lane: 0 }, { time: 133.35, lane: 1 }, { time: 133.7, lane: 2 }, { time: 134.05, lane: 3 },
                    { time: 134.4, lane: 0 }, { time: 134.4, lane: 3 },
                    { time: 135.1, lane: 1 }, { time: 135.1, lane: 2 },
                    { time: 135.8, lane: 0 }, { time: 136.5, lane: 2 }, { time: 137.2, lane: 1 }, { time: 137.9, lane: 3 },
                    { time: 138.6, lane: 0 }, { time: 139.3, lane: 1 }, { time: 140.0, lane: 2 }, { time: 140.7, lane: 3 },
                    { time: 141.4, lane: 0 }, { time: 141.4, lane: 1 }, { time: 141.4, lane: 2 }, { time: 141.4, lane: 3 },
                ]
            },
            {
                title: "Play the Game",
                artist: "You!",
                url: "https://raw.githubusercontent.com/CoryBouchard/html5-rhythm-game/main/PlaytheGame.mp3",
                bpm: 150, // You might need to adjust this
                beatmap: [{"time":0,"lane":0},{"time":0.256,"lane":1},{"time":0.277,"lane":2},{"time":0.299,"lane":3},{"time":0.32,"lane":0},{"time":6.571,"lane":1},{"time":6.976,"lane":2},{"time":7.36,"lane":3},{"time":7.723,"lane":0},{"time":7.765,"lane":1},{"time":8.192,"lane":2},{"time":8.939,"lane":3},{"time":9.301,"lane":0},{"time":9.344,"lane":1},{"time":9.728,"lane":2},{"time":9.749,"lane":3},{"time":10.133,"lane":0},{"time":10.475,"lane":1},{"time":10.517,"lane":2},{"time":10.901,"lane":3},{"time":11.307,"lane":0},{"time":11.328,"lane":1},{"time":12.075,"lane":2},{"time":12.096,"lane":3},{"time":12.459,"lane":0},{"time":12.48,"lane":1},{"time":12.821,"lane":2},{"time":12.864,"lane":3},{"time":12.885,"lane":0},{"time":13.291,"lane":1},{"time":13.675,"lane":2},{"time":14.059,"lane":3},{"time":14.08,"lane":0},{"time":14.101,"lane":1},{"time":15.232,"lane":2},{"time":15.253,"lane":3},{"time":15.637,"lane":0},{"time":15.659,"lane":1},{"time":16.021,"lane":2},{"time":16.043,"lane":3},{"time":16.064,"lane":0},{"time":17.216,"lane":1},{"time":17.259,"lane":2},{"time":18.027,"lane":3},{"time":18.411,"lane":0},{"time":18.752,"lane":1},{"time":18.816,"lane":2},{"time":19.2,"lane":3},{"time":19.221,"lane":0},{"time":19.989,"lane":1},{"time":20.395,"lane":2},{"time":20.416,"lane":3},{"time":21.184,"lane":0},{"time":21.568,"lane":1},{"time":21.973,"lane":2},{"time":22.229,"lane":3},{"time":22.763,"lane":0},{"time":23.083,"lane":1},{"time":23.125,"lane":2},{"time":23.147,"lane":3},{"time":23.723,"lane":0},{"time":23.765,"lane":1},{"time":23.787,"lane":2},{"time":23.957,"lane":3},{"time":24.341,"lane":0},{"time":24.725,"lane":1},{"time":25.131,"lane":2},{"time":25.152,"lane":3},{"time":25.515,"lane":0},{"time":25.536,"lane":1},{"time":25.643,"lane":2},{"time":25.92,"lane":3},{"time":26.304,"lane":0},{"time":27.499,"lane":1},{"time":27.883,"lane":2},{"time":28.245,"lane":3},{"time":28.288,"lane":0},{"time":28.544,"lane":1},{"time":29.077,"lane":2},{"time":29.461,"lane":3},{"time":29.867,"lane":0},{"time":30.123,"lane":1},{"time":30.272,"lane":2},{"time":30.976,"lane":3},{"time":31.04,"lane":0},{"time":31.445,"lane":1},{"time":31.616,"lane":2},{"time":31.659,"lane":3},{"time":31.829,"lane":0},{"time":31.851,"lane":1},{"time":32.619,"lane":2},{"time":33.024,"lane":3},{"time":33.237,"lane":0},{"time":33.813,"lane":1},{"time":34.795,"lane":2},{"time":34.816,"lane":3},{"time":34.859,"lane":0},{"time":35.008,"lane":1},{"time":35.392,"lane":2},{"time":36.203,"lane":3},{"time":36.416,"lane":0},{"time":36.437,"lane":1},{"time":36.971,"lane":2},{"time":37.952,"lane":3},{"time":37.973,"lane":0},{"time":38.144,"lane":1},{"time":38.165,"lane":2},{"time":39.552,"lane":3},{"time":39.573,"lane":0},{"time":40.128,"lane":1},{"time":40.747,"lane":2},{"time":41.173,"lane":3},{"time":41.707,"lane":0},{"time":42.432,"lane":1},{"time":42.752,"lane":2},{"time":43.285,"lane":3},{"time":44.053,"lane":0},{"time":44.075,"lane":1},{"time":44.459,"lane":2},{"time":44.48,"lane":3},{"time":44.864,"lane":0},{"time":44.885,"lane":1},{"time":45.568,"lane":2},{"time":45.653,"lane":3},{"time":46.059,"lane":0},{"time":46.827,"lane":1},{"time":47.211,"lane":2},{"time":47.232,"lane":3},{"time":47.253,"lane":0},{"time":47.616,"lane":1},{"time":47.637,"lane":2},{"time":48.021,"lane":3},{"time":48.384,"lane":0},{"time":48.427,"lane":1},{"time":48.768,"lane":2},{"time":48.811,"lane":3},{"time":49.984,"lane":0},{"time":50.368,"lane":1},{"time":50.411,"lane":2},{"time":50.795,"lane":3},{"time":51.179,"lane":0},{"time":51.349,"lane":1},{"time":51.371,"lane":2},{"time":51.435,"lane":3},{"time":51.499,"lane":0},{"time":52.288,"lane":1},{"time":52.352,"lane":2},{"time":52.373,"lane":3},{"time":53.141,"lane":0},{"time":53.547,"lane":1},{"time":53.568,"lane":2},{"time":55.104,"lane":3},{"time":55.125,"lane":0},{"time":55.509,"lane":1},{"time":55.531,"lane":2},{"time":55.915,"lane":3},{"time":56.299,"lane":0},{"time":56.704,"lane":1},{"time":57.109,"lane":2},{"time":58.091,"lane":3},{"time":58.475,"lane":0},{"time":58.496,"lane":1},{"time":58.645,"lane":2},{"time":59.072,"lane":3},{"time":59.883,"lane":0},{"time":60.117,"lane":1},{"time":60.267,"lane":2},{"time":60.651,"lane":3},{"time":61.653,"lane":0},{"time":61.675,"lane":1},{"time":61.845,"lane":2},{"time":62.229,"lane":3},{"time":62.976,"lane":0},{"time":63.019,"lane":1},{"time":63.04,"lane":2},{"time":63.403,"lane":3},{"time":63.424,"lane":0},{"time":64.597,"lane":1},{"time":64.619,"lane":2},{"time":64.725,"lane":3},{"time":64.832,"lane":0},{"time":66.432,"lane":1},{"time":67.093,"lane":2},{"time":67.136,"lane":3},{"time":67.755,"lane":0},{"time":68.139,"lane":1},{"time":68.16,"lane":2},{"time":68.8,"lane":3},{"time":68.843,"lane":0},{"time":68.928,"lane":1},{"time":68.949,"lane":2},{"time":69.333,"lane":3},{"time":69.504,"lane":0},{"time":69.525,"lane":1},{"time":69.547,"lane":2},{"time":69.739,"lane":3},{"time":70.912,"lane":0},{"time":71.125,"lane":1},{"time":72.704,"lane":2},{"time":72.896,"lane":3},{"time":74.091,"lane":0},{"time":74.325,"lane":1},{"time":75.861,"lane":2},{"time":76.053,"lane":3},{"time":77.461,"lane":0},{"time":78.635,"lane":1},{"time":79.061,"lane":2},{"time":79.211,"lane":3},{"time":80.213,"lane":0},{"time":80.341,"lane":1},{"time":80.64,"lane":2},{"time":82.219,"lane":3},{"time":82.24,"lane":0},{"time":82.368,"lane":1},{"time":83.797,"lane":2},{"time":83.819,"lane":3},{"time":85.376,"lane":0},{"time":85.525,"lane":1},{"time":86.037,"lane":2},{"time":86.699,"lane":3},{"time":86.72,"lane":0},{"time":88.533,"lane":1},{"time":88.683,"lane":2},{"time":88.811,"lane":3},{"time":88.875,"lane":0},{"time":90.112,"lane":1},{"time":90.261,"lane":2},{"time":91.456,"lane":3},{"time":91.691,"lane":0},{"time":91.712,"lane":1},{"time":92.373,"lane":2},{"time":92.416,"lane":3},{"time":94.592,"lane":0},{"time":94.997,"lane":1},{"time":95.616,"lane":2},{"time":95.979,"lane":3},{"time":96,"lane":0},{"time":96.363,"lane":1},{"time":96.384,"lane":2},{"time":96.405,"lane":3},{"time":97.365,"lane":0},{"time":97.664,"lane":1},{"time":97.685,"lane":2},{"time":97.771,"lane":3},{"time":98.517,"lane":0},{"time":98.539,"lane":1},{"time":98.56,"lane":2},{"time":98.944,"lane":3},{"time":99.541,"lane":0},{"time":99.563,"lane":1},{"time":100.523,"lane":2},{"time":100.864,"lane":3},{"time":100.885,"lane":0},{"time":100.928,"lane":1},{"time":100.949,"lane":2},{"time":101.312,"lane":3},{"time":101.717,"lane":0},{"time":101.931,"lane":1},{"time":102.485,"lane":2},{"time":102.507,"lane":3},{"time":102.592,"lane":0},{"time":102.613,"lane":1},{"time":102.72,"lane":2},{"time":103.637,"lane":3},{"time":103.659,"lane":0},{"time":103.68,"lane":1},{"time":104.427,"lane":2},{"time":104.469,"lane":3},{"time":105.088,"lane":0},{"time":105.259,"lane":1},{"time":105.643,"lane":2},{"time":106.048,"lane":3},{"time":106.069,"lane":0},{"time":106.837,"lane":1},{"time":107.221,"lane":2},{"time":107.243,"lane":3},{"time":107.413,"lane":0},{"time":107.456,"lane":1},{"time":107.627,"lane":2},{"time":108.779,"lane":3},{"time":108.821,"lane":0},{"time":109.013,"lane":1},{"time":109.035,"lane":2},{"time":109.611,"lane":3},{"time":110.592,"lane":0},{"time":110.635,"lane":1},{"time":110.656,"lane":2},{"time":110.784,"lane":3},{"time":111.189,"lane":0},{"time":112.213,"lane":1},{"time":113.749,"lane":2},{"time":113.941,"lane":3},{"time":114.112,"lane":0},{"time":115.349,"lane":1},{"time":115.925,"lane":2},{"time":116.544,"lane":3},{"time":116.949,"lane":0},{"time":116.971,"lane":1},{"time":117.099,"lane":2},{"time":118.549,"lane":3},{"time":120.128,"lane":0},{"time":120.256,"lane":1},{"time":120.277,"lane":2},{"time":121.685,"lane":3},{"time":121.707,"lane":0},{"time":123.264,"lane":1},{"time":123.285,"lane":2},{"time":123.819,"lane":3},{"time":124.587,"lane":0},{"time":124.608,"lane":1},{"time":124.992,"lane":2},{"time":126.443,"lane":3},{"time":126.571,"lane":0},{"time":128.021,"lane":1},{"time":128.149,"lane":2},{"time":129.344,"lane":3},{"time":129.579,"lane":0},{"time":129.6,"lane":1},{"time":129.728,"lane":2},{"time":130.965,"lane":3},{"time":134.464,"lane":0},{"time":134.869,"lane":1},{"time":135.253,"lane":2},{"time":135.659,"lane":3},{"time":136.043,"lane":0},{"time":136.064,"lane":1},{"time":136.832,"lane":2},{"time":136.853,"lane":3},{"time":137.216,"lane":0},{"time":137.237,"lane":1},{"time":137.621,"lane":2},{"time":137.643,"lane":3},{"time":138.027,"lane":0},{"time":138.411,"lane":1},{"time":138.432,"lane":2},{"time":138.816,"lane":3}]
            }
        ];

        // --- Initialization ---
        function init() {
            setupCanvas();
            populateSongSelect();
            addEventListeners();
        }

        function setupCanvas() {
            const container = document.getElementById('game-container');
            const dpr = window.devicePixelRatio || 1;
            const rect = container.getBoundingClientRect();
            canvas.width = rect.width * dpr;
            canvas.height = (window.innerHeight * 0.7) * dpr;
            canvas.style.width = `${rect.width}px`;
            canvas.style.height = `${window.innerHeight * 0.7}px`;
            ctx.scale(dpr, dpr);
        }

        function populateSongSelect() {
            songs.forEach((song, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `${song.title} - ${song.artist}`;
                songSelect.appendChild(option);
            });
        }

        function addEventListeners() {
            startButton.addEventListener('click', startGame);
            restartButton.addEventListener('click', resetGame);
            window.addEventListener('keydown', handleKeyPress);
            window.addEventListener('keyup', handleKeyRelease);
            window.addEventListener('resize', setupCanvas);

            // Touch/Mouse controls
            Object.values(keyElements).forEach((el, index) => {
                el.addEventListener('mousedown', () => handleTouchPress(index));
                el.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    handleTouchPress(index);
                });
            });
        }

        // --- Game Flow ---
        function startGame() {
            const selectedSongIndex = songSelect.value;
            currentSong = songs[selectedSongIndex];

            score = 0;
            combo = 0;
            maxCombo = 0;
            updateUI();

            upcomingTiles = [...currentSong.beatmap].sort((a, b) => a.time - b.time);
            tiles = [];

            gameAudio.src = currentSong.url;
            gameAudio.load();
            
            startScreen.classList.add('hidden');
            endScreen.classList.add('hidden');
            gameScreen.classList.remove('hidden');

            gameAudio.oncanplaythrough = () => {
                if(gameAudio.oncanplaythrough) { 
                    gameAudio.oncanplaythrough = null;
                    gameAudio.play();
                    audioStartTime = performance.now();
                    isPlaying = true;
                    gameLoop();
                }
            };
            
            gameAudio.onended = () => {
                setTimeout(endGame, 1000);
            };
        }
        
        function endGame() {
            isPlaying = false;
            cancelAnimationFrame(animationFrameId);
            gameScreen.classList.add('hidden');
            finalScoreDisplay.textContent = score;
            maxComboDisplay.textContent = maxCombo;
            endScreen.classList.remove('hidden');
        }

        function resetGame() {
            endScreen.classList.add('hidden');
            startScreen.classList.remove('hidden');
            gameAudio.oncanplaythrough = null;
        }

        // --- Game Loop ---
        function gameLoop() {
            if (!isPlaying) return;
            const currentTime = gameAudio.currentTime;
            update(currentTime);
            draw();
            animationFrameId = requestAnimationFrame(gameLoop);
        }

        function update(currentTime) {
            while (upcomingTiles.length > 0 && upcomingTiles[0].time < currentTime + (canvas.clientHeight / tileSpeed)) {
                tiles.push(upcomingTiles.shift());
            }
            const targetY = canvas.clientHeight - tileHeight * 1.5;
            tiles = tiles.filter(tile => {
                const timeDifference = tile.time - currentTime;
                if (timeDifference < -hitWindows.miss) {
                    combo = 0;
                    showFeedback('Miss', 'text-red-500');
                    return false;
                }
                return true;
            });
            updateUI();
        }

        function draw() {
            const canvasWidth = canvas.clientWidth;
            const canvasHeight = canvas.clientHeight;
            const laneWidth = canvasWidth / lanes;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            for (let i = 1; i < lanes; i++) {
                ctx.fillStyle = 'rgba(255, 255, 255, 0.1)';
                ctx.fillRect(i * laneWidth - 1, 0, 2, canvasHeight);
            }
            const targetY = canvasHeight - tileHeight * 1.5;
            ctx.fillStyle = 'rgba(0, 255, 255, 0.5)';
            ctx.fillRect(0, targetY, canvasWidth, tileHeight);
            ctx.strokeStyle = '#00FFFF';
            ctx.lineWidth = 3;
            ctx.strokeRect(0, targetY, canvasWidth, tileHeight);
            const currentTime = gameAudio.currentTime;
            tiles.forEach(tile => {
                const timeDifference = tile.time - currentTime;
                const y = targetY - (timeDifference * tileSpeed);
                ctx.fillStyle = laneColors[tile.lane];
                ctx.fillRect(tile.lane * laneWidth, y, laneWidth, tileHeight);
                ctx.strokeStyle = 'rgba(255, 255, 255, 0.8)';
                ctx.strokeRect(tile.lane * laneWidth, y, laneWidth, tileHeight);
            });
        }

        // --- Input Handling ---
        function handleKeyPress(e) {
            if (!isPlaying || !keyMap.hasOwnProperty(e.key)) return;
            const lane = keyMap[e.key];
            checkHit(lane);
            const keyEl = keyElements[e.key];
            if (keyEl) keyEl.classList.add('pressed');
        }

        function handleKeyRelease(e) {
            if (!keyMap.hasOwnProperty(e.key)) return;
            const keyEl = keyElements[e.key];
            if (keyEl) keyEl.classList.remove('pressed');
        }
        
        function handleTouchPress(lane) {
            if (!isPlaying) return;
            checkHit(lane);
            const key = Object.keys(keyMap).find(k => keyMap[k] === lane);
            const keyEl = keyElements[key];
            if (keyEl) {
                keyEl.classList.add('pressed');
                setTimeout(() => keyEl.classList.remove('pressed'), 100);
            }
        }

        function checkHit(lane) {
            const currentTime = gameAudio.currentTime;
            let hit = false;
            for (let i = 0; i < tiles.length; i++) {
                const tile = tiles[i];
                if (tile.lane === lane) {
                    const timeDifference = Math.abs(tile.time - currentTime);
                    if (timeDifference <= hitWindows.perfect) {
                        score += scores.perfect;
                        combo++;
                        showFeedback('Perfect!', 'text-cyan-400');
                        tiles.splice(i, 1);
                        hit = true;
                        break;
                    } else if (timeDifference <= hitWindows.great) {
                        score += scores.great;
                        combo++;
                        showFeedback('Great!', 'text-green-400');
                        tiles.splice(i, 1);
                        hit = true;
                        break;
                    } else if (timeDifference <= hitWindows.good) {
                        score += scores.good;
                        combo++;
                        showFeedback('Good', 'text-yellow-400');
                        tiles.splice(i, 1);
                        hit = true;
                        break;
                    }
                }
            }
            if (hit) {
                if (combo > maxCombo) {
                    maxCombo = combo;
                }
            }
            updateUI();
        }

        // --- UI Updates ---
        function updateUI() {
            scoreDisplay.textContent = score;
            comboDisplay.textContent = combo;
        }

        function showFeedback(text, colorClass) {
            const feedbackEl = document.createElement('div');
            feedbackEl.textContent = text;
            feedbackEl.className = `feedback absolute text-5xl font-bold ${colorClass} pointer-events-none`;
            while (feedbackContainer.firstChild) {
                feedbackContainer.removeChild(feedbackContainer.firstChild);
            }
            feedbackContainer.appendChild(feedbackEl);
        }

        // --- Run Initialization ---
        init();

    </script>
</body>
</html>
